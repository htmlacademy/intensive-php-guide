---
layout: page
title: "Реляционные базы данных: теория"
permalink: db_theory
---

## Что такое базы данных (БД) и зачем они нужны
База данных (БД) - это программа, которая позволяет хранить и обрабатывать информацию в структурированном виде.  
БД не входит в состав языка программирования, а является отдельной программой и работает независимо. 
Используя возможности базы данных, программист может сохранять любую информацию, чтобы в дальнейшем получить к ней доступ.

### Пример использования
Базы данных нужны для хранения информации. Но чтобы получить полное понимание необходимости использования БД в современном веб-программировании, необходимо ответить на три вопроса:  
1. Какую информацию и зачем мы храним?
2. В каком виде и как надо хранить эту информацию?
3. Как и каким способом можно получить доступ к этой информации?

Предположим, вы решили сделать сайт, где каждый пользователь может вести онлайн личный дневник наблюдения за погодой в своем городе.  
Это означает, что такой сайт должен иметь как минимум одну форму со следующими полями: город, дата, температура, облачность, явление, и т.д.  
Каждый день наблюдатель записывает показания погоды в эту форму, чтобы когда-нибудь в будущем вернуться на сайт и посмотреть какая была погода месяц или даже год назад.  
Из этого примера следует, что программист каким-то образом должен сохранять данные из формы с целью её дальнейшего использования.  

Но помимо обычного просмотра дневника погоды за месяц в виде таблицы, можно делать более сложные вещи.  
Например, чтобы электронный дневник чем-то качественно отличался от своего бумажного аналога, будет неплохо добавить туда возможности для простого анализа: показать какой день был самым холодным в ноябре или какой продолжительности была самая длинная серия пасмурных дней.  
Получается, что данные надо не просто как-то хранить, но и иметь возможность их обрабатывать и анализировать.  
Именно для этих целей и существуют базы данных.

## Как хранится информация в БД
В основе всей структуры хранения лежит три понятия:

* база данных
* таблица
* запись

### База данных (БД)
БД - это высокоуровневное понятие.Означает объединение совокупности данных, хранимых для выполнения одной цели.  
Так, если мы делаем современный веб-сайт, то все свои данные он будет хранить внутри одной базы данных. Для сайта онлайн дневника наблюдений за погодой тоже понадобится создать отдельную базу данных.

### Таблица
Таблица является вложенным объектом по отношению к базе данных. Т.е. одна БД может содержать в себе множество таблиц.  
Аналогией из реального мира может быть шкаф (База Данных) внутри которого лежит множество коробок (таблиц).  
Сама таблица нужна для хранения данных одного типа. Например: список городов, список пользователей, библиотечный каталог.  
Таблицу можно представить как обычный лист в Excel таблице, т.е. совокупность строк и столбцов.  
Наверняка каждый хоть раз имел дело с электронными таблицами (MS Excel).  
Заполняя такую таблицу, пользователь определяет столбцы, каждый из которых имеет заголовок. В строках же хранится уже непосредственно информация.  
В БД точно также: создавая новую таблицу, необходимо описать из каких столбцов она состоит и дать им имена.

### Запись
Запись — это строка в терминах электронных таблиц.  
Запись — это и есть та неделимая сущность, которая хранится в таблицах.  Когда мы сохраняем данные веб-формы с сайта, то на самом деле добавляем новую запись в соответствующую таблицу.
Запись состоит из полей (столбцов) и их значений.  Но значения не могут быть абы какими.  
Определяя столбец, программист должен указать какой тип данных этот столбец будет хранить: текстовый, числовой, логический, файловый и т.д.  БД не позволит записать данные неверного типа.

Соберем все вместе, чтобы понять как будет выглядеть ведение дневника погоды при участии БД.  
1. Создадим для сайта новую БД и дадим ей название "weather_diary"
2. Создадим в БД новую таблицу с именем "weather_log" и определим там следующие столбцы:
* город (тип: текст)
* день (тип: дата)
* температура (тип: число)
* облачность (тип: число; от 0 (нет облачности) до 4 (полная облачность))
* были ли осадки (тип: истина или ложь)
* комментарий (тип: текст)
3. При сохранении формы будем добавлять в таблицу weather_log новую запись и заполнять в ней все поля информацией из полей формы

Теперь можно быть уверенным, что наблюдения наших пользователей никуда не потеряются и к ним всегда можно будет получить доступ.

### Реляционная база данных
Английское слово "relation" можно перевести как связь, отношение.  
А определение "реляционные базы данных" означает, что таблицы в этой БД могут вступать в отношения и находиться в связи между собой.  
Что это за связи?   
Например, одна таблица может ссылаться на другую таблицу. Это часто требуется, чтобы сократить объем и избежать дублирование информации.  
В сценарии с дневником погоды, пользователь вводит название своего города. Это название сохраняется вместе с погодными данными.  
Но можно поступить иначе:
1. Создать новую таблицу с именем "cities"
2. Все города в России известны, поэтому можно один раз сохранить их всех в этой таблице
3. Переделать форму, изменив поле ввода города с текстового на поле типа "select", чтобы пользователь не вписывал город, а выбирал его из списка
4. При сохранении погодной записи в поле для города поставить ссылку на соответствующую запись из таблицы городов

Этим мы убьем сразу двух зайцев:
* сократим объем хранимой информации, т.к. погодные записи больше не будут содержать название города
* избежим дублирования: все пользователи будут выбирать один из заранее определенных городов, что исключит опечатки

Связи между таблицами в БД бывают разных видов.  
В примере выше использовалась связь типа "Один-ко-многим", т.к. одному городу может соответствовать множество погодных записей, но не наоборот!  
Бывают связи и других типов: "один-к-одному" и "многие-ко-многим", но они используются значительно реже.

## Язык запросов
Как уже известно, база данных, а точнее система управления базами данных (СУБД) - это отдельная программа, которая работает как сервер независимо от PHP.  
Создавать свои базы данных, таблицы и наполнять их данными можно прямо из этой же программы, но для выполнения этих операций прежде придется познакомиться с еще одним языком программирования - SQL.  

SQL или Structured Query Language (язык структурированных запросов) - язык программирования, предназначенный для управления данными в СУБД. Все современные СУБД поддерживают SQL.  

На языке SQL выражаются все действия, которые можно провести с данными: от записи и чтения данных до
администрирования самого сервера СУБД.  
Для повседневной работы совсем не обязательно знать весь этот язык; достаточно ознакомиться лишь с основными понятиями синтаксиса и ключевыми словами. Кроме того, SQL очень простой язык по своей структуре, поэтому его освоение не составит большого труда.  

Язык SQL - это в первую очередь язык запросов, а кроме того он очень похож на естественный язык.  
Каждый раз, когда требуется прочитать или записать любую информацию в БД, требуется составить корректный запрос. Такой запрос должен быть выражен в терминах SQL.  

Например, чтобы вывести на экран все записи из таблицы `города`, составим такой запрос:
 ```
 ПРОЧИТАТЬ всё ИЗ ТАБЛИЦЫ 'города'
 ```
Если перевести этот запрос на язык SQL, то корректным результатом будет:
```
SELECT * FROM 'cities'
```

Теперь напишем запрос на добавление в таблицу `города` нового города:
```
ВСТАВЬ В ТАБЛИЦУ 'города' ЗНАЧЕНИЯ 'имя города' = 'Санкт-Петербург'
```
Перевод на SQL:
```
INSERT INTO 'cities' SET 'name' = 'Санкт-Петербург'
```
Эта команда создаст в таблице 'города' новую запись, где полю 'имя города' будет присвоено значение 'Санкт-Петербург'.  

С помощью SQL можно не только добавлять и читать данные, но и:
* удалять и обновлять записи в таблицах
* создавать и редактировать сами таблицы
* производить операции над данными: считать сумму, получать самое большое или малое значение и т.д.
* настраивать работу сервера СУБД

## MySQL
Существует множество различных реляционных СУБД. Самая известная широкому кругу людей СУБД - это Microsoft Access, входящая в состав офисного пакета приложений Microsoft Office.  
Нет никаких препятствий для использования в качестве СУБД MS Access, но для задач веб-программирования гораздо лучше подходит альтернативная программа - MySQL.  
В отличие от MS Access, MySQL абсолютно бесплатна, может работать на серверах с Linux, обладает гораздо большей производительностью и безопасностью, что делает её идеальным кандидатом на роль базы данных в веб разработке.  
Подавляющее большинство сайтов и приложений на PHP используют в качестве СУБД именно MySQL.

## Установка
Если для своей работы вы используете программную среду OpenServer, то этот раздел можно смело пропустить, т.к. в состав OpenServer уже входит свежая версия MySQL.

Последняя версия MySQL доступна для загрузке по ссылке: https://dev.mysql.com/downloads/mysql/  
На этой странице следует выбрать "MySQL Installer for Windows" и нажать на кнопку "Download" для загрузки.

В процессе установки запомните директорию, куда вы устанавливаете MySQL (скрывается под ссылкой "Advanced options").  
На шаге "Accounts and Roles" установщик потребует придумать пароль для доступа к БД (MySQL Root Password) - обязательно запомните или запишите этот пароль - он вам еще понадобится.

## Выполнение запросов
По умолчанию, если вы не устанавливали дополнительные программы, у MySQL нет графического интерфейса пользователя. Это значит, что единственный способ работы с ней - это использование командной строки.  
1. Откройте командную строку (Выполнить: cmd.exe)
2. Перейдите в каталог с установленной MySQL: `cd /d <каталог установки>/bin`
3. Выполните: `mysql -uroot -p`
4. Введите пароль, заданный при установке

Если вы все выполнили верно, то в командной строке запустится клиент для работы с MySQL (вы поймете это по строке приглашения "mysql>").
С этого момента можно вводить любые SQL запросы, но каждый запрос обязательно должен заканчиваться точкой с запятой `;`

## Создание новой базы данных
Приступим к практике - начнем создавать базу данных для ведения погодного дневника.  
Начать следует с создания новой базы данных для нашего сайта.  
Новая БД в MySQL создается простой командой:
`CREATE DATABASE <имя базы данных>`  

Так что выполнив команду `CREATE DATABASE weather_diary;`, MySQL создаст для нас новую БД, в которой будет происходить вся дальнейшая работа.  
Это важно: после создания БД её невозможно будет переименовать, а только удалить и создать заново. По этой причине крайне внимательно подойдите к выбору имени для базы данных.

## Создание таблиц
Создав новую БД, сообщим MySQL, что теперь мы собираемся работать именно с ней.  
Выбор активной БД выполняется командой: `USE <имя базы>;`

Пришло время создать первые таблицы!  
Для ведения дневника по всем правилам, понадобится создать три таблицы: города (cities), пользователи (users) и записи о погоде (weather_log).  
В подразделе "Запись" этой главы описано, как должна выглядеть структура таблицы weather_log. Переведем это описание на язык SQL:
```
CREATE TABLE weather_log (
id INT AUTO_INCREMENT PRIMARY KEY,
city_id INT,
day DATE,
temperature INT,
cloud TINYINT DEFAULT 0
);
```
Чтобы ввести многострочную команду в командной строке используйте символ `\` в конце каждой строки (кроме последней).

Теперь создадим таблицу городов:  
```
CREATE TABLE cities (
id INT AUTO_INCREMENT PRIMARY KEY,
name CHAR(128)
)
```

MySQL может показать созданную таблицу, если попросить об этом командой: `SHOW COLUMNS FROM weather_log`.  
В ответе будут перечислены все поля в таблицы, их тип и другие характеристики.

### Первичный ключ
В примере с созданием новой таблицы при перечислении необходимых полей первым полем идет `id INT AUTO_INCREMENT PRIMARY KEY`.  
Это поле называется первичным ключом. Вы должны создавать первичный ключ в каждой таблице.  

Первичный ключ - это особенное поле, в котором сохраняется уникальный идентификатор записи. Он нужен, чтобы у программиста и базы данных всегда была возможность однозначно обратиться к одной конкретной записи для её чтения, обновления или удаления.  
Если назначить поле первичным ключом, то БД будет следить за тем, чтобы значение в этом поле больше не повторялось в таблице.  
А если еще и добавить аттрибут `AUTO_INCREMENT`, то MySQL при добавлении новых записей будет заполнять это поле сама, за нас. 
`AUTO_INCREMENT` будет играть роль счетчика - каждая новая запись в таблице получит значение на единицу больше максимального существующего значения.

## Запись данных в БД
Начнем с добавления новых данных в таблицу.
Для добавления новой записи используется следующий синтаксис:  

`insert into <название таблицы> set <имя столбца1> = <значение2>, <имя столбца2> = <значение2>...`

В начале добавим новый город в таблицу городов:  
`insert into cities set name = 'Санкт-Петербург'`

При добавлении записи не обязательно указывать значения для всех полей. Многие из полей имеют значения по умолчанию, которые сами заполняются при сохранении.

Теперь создадим запись о погоде за сегодняшний день.  
При определении таблицы weather_log мы решили ссылаться на город, путем записи в поле city_id идентификатора города из таблицы cities.
Т.к. мы только что добавили новый город, ничего не мешает использовать его идентификатор в записи о погоде.  
Идентификатором города будет первичный ключ, который также был определен в качестве первого поля таблицы. Нумерация этого поля начинается с единицы, значит первая добавленная запись имеет идентификатор `1`. Зная это, запрос на добавление записи о погоде в Санкт-Петербурге за третье сентября 2017 года выглядит так:

`INSERT INTO weather_log SET city_id = 1, day = '2017-09-03', temperature = 5, cloud = 1;`

## Чтение информации из БД
Для вывода информации из БД используются запросы типа `SELECT`.  
В запросе нужно указать имя таблицы, необходимые поля, а также дополнительные параметры (будут рассмотрены в следующем
уроке).

`SELECT <перечисление полей> FROM <имя таблицы>`

Например, чтобы получить список всех доступных городов:

`SELECT id, name FROM cities`

Все погодные записи:

`SELECT id, day, city_id, temperature, cloud FROM weather_log`

Вместо перечисления всех столбцов можно использовать знак звездочки - `*`.

## Обновление информации в БД
При добавлении записи очень легко совершить ошибку: сделать опечатку, не указать значение для одного из полей, и т.д.  
Естественно, язык SQL предлагает возможности для редактирования уже созданных записей.  

Предположим, что при добавлении погодной записи пользователь ошибся и ввел неверную дату. Чтобы исправить эту ошибку
нужно использовать оператор обновления - `UPDATE`.  
Запрос с этим оператором позволяет обновить значение одного или нескольких полей в существующей записи. Выглядит он так:  
`UPDATE <имя таблицы> SET <имя столбца1> = <значение2>, <имя столбца2> = <значение2>... WHERE <имя столбца> = <значение>`  

Но чтобы правильно составить запрос, необходимо определить условие для поиска записи, которую предлагается обновить.
В противном случае, если не указать это условие, то будут обновлены абсолютно все записи в таблице.  
Правильнее всего в качестве такого условия использовать первичный идентификатор записи. Поэтому, прежде чем выполнять
запрос обновления, нужно выполнить запрос на чтение информации из таблицы, чтобы узнать, под каким идентификатором
сохранилась ошибочная запись.   
Допустим, этот идентификатор - единица, а правильная дата - пятое сентября 2017 года.

Запрос на обновление:  
`UPDATE weather_log SET day = '2017-09-05' WHERE id = 1`

## Объединение записей из двух таблиц
В нашей таблице для хранения погодного дневника город сохраняется как идентификатор, поэтому при обычном чтении данных
из этой таблицы вместо названия города стоит непонятное число.  Чтобы подставить на место числа действительное значение,
а конкретнее - название города, в SQL существуют операторы объединения - `JOIN`.  
Поддержка операторов объединения и позволяет базе данных называться *реляционной*.  

Поменяем запрос на показ погодных записей, чтобы он объединял две таблицы, а в поле города показывалось его имя, а не
идентификатор:

`SELECT day, cities.name, temperature, cloud FROM weather_log JOIN cities ON weather_log.city_id = cities.id`

Важно усвоить три самых главных момента:
1. При чтении из объединенных таблиц, в перечислении полей после SELECT нужно явно указывать в имени поле также имя
таблицы, с которой производится объединение
2. Всегда есть основная таблица (тб1) из которой читается большинство полей и присоединяемая (тб2), имя которой
определяется после оператора JOIN
3. Помимо указания имени второй таблицы, обязательно следует указать условие, по которому будет происходить объединение.
В этом примере таким условием будет соответствие идентификатора города из тб1 (weather_log.city_id) первичному ключу
города из тб2 (cities.id)
